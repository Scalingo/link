name: Publish

on:
  pull_request:
  push:
    branches: [main, master, prod]
    tags:
      - "v*"

jobs:
  linter:
    name: Linter on a PR
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-24.04
    steps:
      - uses: Scalingo/actions/go-linter@main

  tests:
    name: Unit Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: Scalingo/actions/go-tests@main
        with:
          etcd: true
        env:
          CODE_PATH: ${{ github.workspace }}

  publish:
    runs-on: ubuntu-24.04
    needs: [tests]
    if: ${{ github.ref_type == 'tag' }}
    env:
      GOX_ARCHITECTURES: amd64 386
    steps:
      # Currently there is no possibility to get a tag name. Hence we filter the GITHUB_REF variable which contains something like "refs/tags/v2.0.0" if the tag is "v2.0.0". The value can be used with "steps.tag_name.outputs.TAG_NAME"
      - name: Get tag name
        id: tag_name
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "TAG_NAME=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "$TAG_NAME"

      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Setup Go environment
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          check-latest: true
      - run: go version

      - name: Build the binaries
        env:
          TAG_NAME: ${{ steps.tag_name.outputs.TAG_NAME }}
        run: |
          go install github.com/mitchellh/gox@latest
          CGO_ENABLED=0 gox -os="linux" -arch="$GOX_ARCHITECTURES" -output="dist/link-${TAG_NAME}-{{.OS}}-{{.Arch}}/{{.Dir}}" -ldflags="-X main.Version=${TAG_NAME}" . ./cmd/...

      - name: Archive the built binaries
        env:
          TAG_NAME: ${{ steps.tag_name.outputs.TAG_NAME }}
        run: |
          for gox_archi in $GOX_ARCHITECTURES; do
            echo "Archive release targetted to $gox_archi"
            # Gox compiles link-client and an executable named "v3" instead of "link"..
            mv "dist/link-${TAG_NAME}-linux-${gox_archi}/v3" "dist/link-${TAG_NAME}-linux-${gox_archi}/link"
            tar --directory=dist -czvf "dist/link-${TAG_NAME}-linux-${gox_archi}.tar.gz" "link-${TAG_NAME}-linux-${gox_archi}"
          done

      - name: Release the new version
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*.tar.gz
